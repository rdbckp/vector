name: Face Vectorize

on:
  workflow_dispatch:
    inputs:
      image_url:
        description: 'Link URL Foto Wajah (PNG/JPG)'
        required: true
      detail_level:
        description: 'Detail Garis (Makin kecil makin tipis/bersih, contoh: 2 s/d 10)'
        default: '5'
        required: true
      contrast_boost:
        description: 'Ketegasan Wajah (Contrast 10-40)'
        default: '25'
        required: true
      turdsize:
        description: 'Hapus Bercak/Kotoran (Turdsize 5-20)'
        default: '10'
        required: true

jobs:
  face-trace:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Pro Tools
        run: sudo apt-get update && sudo apt-get install -y imagemagick potrace

      - name: Transform Face to Stencil
        run: |
          # 1. Download
          curl -L "${{ github.event.inputs.image_url }}" -o "face_input"
          
          if [ ! -s "face_input" ]; then
            echo "‚ùå Link foto mati atau gak bisa di-download!"
            exit 1
          fi

          # 2. Masak Foto Wajah (Stencil Logic)
          # -colorspace gray: Jadi abu-abu
          # -edge: Nyari garis fitur wajah (mata, bibir, dsb)
          # -negate: Balik warna biar jadi line art hitam di atas putih
          convert face_input \
                  -colorspace gray \
                  -selective-blur 0x2+10% \
                  -edge ${{ github.event.inputs.detail_level }} \
                  -negate \
                  -sigmoidal-contrast ${{ github.event.inputs.contrast_boost }}x50% \
                  -threshold 70% \
                  temp_face.bmp

          # 3. Tracing ke SVG
          potrace temp_face.bmp \
                  -s \
                  --alphamax 1.1 \
                  --turdsize ${{ github.event.inputs.turdsize }} \
                  -o face_vector.svg

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "face-v${{ github.run_number }}"
          name: "Face Vector Result #${{ github.run_number }}"
          body: |
            **Face Specs:**
            - Detail: ${{ github.event.inputs.detail_level }}
            - Contrast: ${{ github.event.inputs.contrast_boost }}
          files: face_vector.svg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
