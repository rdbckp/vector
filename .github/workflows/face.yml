name: Face Vectorize

on:
  workflow_dispatch:
    inputs:
      image_url:
        description: 'Link URL Foto (Kosongkan jika ingin pakai file di repo)'
        required: false
      file_name:
        description: 'Nama File di Repo (Jika URL kosong. Contoh: input.jpg)'
        default: ''
        required: false
      shadow_boost:
        description: 'Ketegasan Shadow (20-40). Makin tinggi makin hitam pekat.'
        default: '30'
        required: true
      levels:
        description: 'Jumlah Layer Warna (6-10). 8 adalah sweet spot.'
        default: '8'
        required: true
      detail_sharpness:
        description: 'Ketajaman Tato/Detail (1-3)'
        default: '2'
        required: true

jobs:
  vectorize-process:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Graphic Engines
        run: |
          sudo apt-get update && sudo apt-get install -y imagemagick
          # Install vtracer engine (x86_64 Linux)
          wget https://github.com/visioncortex/vtracer/releases/latest/download/vtracer-x86_64-unknown-linux-musl.tar.gz
          tar -xvf vtracer-x86_64-unknown-linux-musl.tar.gz
          chmod +x vtracer
          sudo mv vtracer /usr/local/bin/

      - name: Fetch and Prepare Image
        run: |
          URL_INPUT="${{ github.event.inputs.image_url }}"
          USER_FILE="${{ github.event.inputs.file_name }}"
          
          if [ -n "$URL_INPUT" ]; then
            echo "üåê Downloading from URL..."
            curl -L "$URL_INPUT" -o "source_img"
            TARGET="source_img"
          elif [ -n "$USER_FILE" ]; then
            TARGET="$USER_FILE"
          else
            TARGET=$(ls input.png input.jpg input.jpeg 2>/dev/null | head -n 1)
          fi
          
          if [ ! -f "$TARGET" ]; then
            echo "‚ùå File kaga nemu, Bro!"
            exit 1
          fi
          
          echo "üöÄ Processing: $TARGET"

          # --- TAHAP PRE-PROCESSING "NANO-STYLE" ---
          # -adaptive-sharpen: Bikin tato & senar bass tajam
          # -adaptive-blur: Bikin gradasi kulit halus (anti-pecah)
          # -contrast-stretch: Mastiin gak ada warna abu-abu "nanggung"
          # -posterize: Bikin layer gradasi artistik
          convert "$TARGET" \
                  -colorspace gray \
                  -adaptive-sharpen 0x${{ github.event.inputs.detail_sharpness }} \
                  -adaptive-blur 0x1 \
                  -contrast-stretch 2%x2% \
                  -level ${{ github.event.inputs.shadow_boost }}%,100% \
                  -posterize ${{ github.event.inputs.levels }} \
                  cooked_temp.png

          # --- TAHAP TRACING (vtracer) ---
          # --mode spline: Bikin garis luwes/curvy (gak kaku/kotak)
          # --filter_speckle: Ngebersihin "sampah" bintik kecil
          vtracer --input cooked_temp.png \
                  --output result_pro.svg \
                  --mode spline \
                  --colormode color \
                  --hierarchical cutout \
                  --filter_speckle 10 \
                  --color_precision 8 \
                  --path_precision 2 \
                  --corner_threshold 60

      - name: Create Release and Upload
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "pro-vector-v${{ github.run_number }}"
          name: "Nano-Style Vector #${{ github.run_number }}"
          body: |
            **Vector Specs:**
            - Shadow Boost: ${{ github.event.inputs.shadow_boost }}
            - Levels: ${{ github.event.inputs.levels }}
            - Sharpness: ${{ github.event.inputs.detail_sharpness }}
          files: result_pro.svg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
