name: Face Vectorize
on:
  workflow_dispatch:
    inputs:
      image_url:
        description: 'Link URL Foto (PNG/JPG)'
        required: true
      posterize_levels:
        description: 'Jumlah Warna (Default 4: Hitam, Abu Tua, Abu Muda, Putih)'
        default: '4'
        required: true
      clean_level:
        description: 'Smoothness (1-3) - Biar gak banyak bintik'
        default: '1'
        required: true

jobs:
  stencil-process:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install ImageMagick
        run: sudo apt-get update && sudo apt-get install -y imagemagick

      - name: Install vtracer (Fast Binary Mode)
        run: |
          # Download vtracer langsung versi Linux binary biar gak Error
          wget https://github.com/visioncortex/vtracer/releases/latest/download/vtracer-linux -O vtracer
          chmod +x vtracer
          sudo mv vtracer /usr/local/bin/

      - name: Image to High-Fidelity Pop-Art
        run: |
          # 1. Download source
          curl -L "${{ github.event.inputs.image_url }}" -o "source_raw"

          # 2. Masak Gambar (Posterize Logic)
          # Biar mirip contoh kanan, kita mainin kontras dan pembagian layer warna
          convert source_raw \
                  -colorspace gray \
                  -modulate 110,130 \
                  -median ${{ github.event.inputs.clean_level }} \
                  -posterize ${{ github.event.inputs.posterize_levels }} \
                  cooked_poster.png

          # 3. Tracing Pake vtracer (Bukan Potrace)
          vtracer --input cooked_poster.png \
                  --output result_popart.svg \
                  --mode spline \
                  --colormode color \
                  --hierarchical cutout \
                  --filter_speckle 4 \
                  --path_precision 3

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "popart-v${{ github.run_number }}"
          name: "High-Fidelity Pop-Art #${{ github.run_number }}"
          body: |
            **Tuning Specs:**
            - Levels: ${{ github.event.inputs.posterize_levels }}
            - Smoothness: ${{ github.event.inputs.clean_level }}
          files: result_popart.svg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
