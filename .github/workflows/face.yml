name: Ultra Pop-Art Stencil (Deep Shadow Edition)

on:
  workflow_dispatch:
    inputs:
      image_url:
        description: 'Link URL Foto (PNG/JPG)'
        required: true
      levels:
        description: 'Jumlah Warna (Rekomendasi: 6-8)'
        default: '8'
        required: true
      shadow_darkness:
        description: 'Shadow Tone (10-30) - Makin besar makin hitam pekat bayangannya'
        default: '20'
        required: true
      contrast_boost:
        description: 'Contrast (1.0 - 1.5)'
        default: '1.2'
        required: true

jobs:
  stencil-process:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Pro Tools
        run: sudo apt-get update && sudo apt-get install -y imagemagick

      - name: Install vtracer
        run: |
          wget https://github.com/visioncortex/vtracer/releases/latest/download/vtracer-x86_64-unknown-linux-musl.tar.gz
          tar -xvf vtracer-x86_64-unknown-linux-musl.tar.gz
          chmod +x vtracer
          sudo mv vtracer /usr/local/bin/

      - name: Image to Deep Shadow Pop-Art
        run: |
          curl -L "${{ github.event.inputs.image_url }}" -o "source_raw"

          # --- JURUS ANTI-LEMES (Shadow & Contrast) ---
          # -level {shadow}%: Paksa warna gelap jadi hitam murni
          # -sigmoidal-contrast: Bikin transisi shadow ke highlight jadi tegas (pop-art style)
          convert source_raw \
                  -colorspace gray \
                  -level ${{ github.event.inputs.shadow_darkness }}%,100% \
                  -sigmoidal-contrast ${{ github.event.inputs.contrast_boost }}x50% \
                  -gaussian-blur 0x0.5 \
                  -posterize ${{ github.event.inputs.levels }} \
                  cooked_poster.png

          vtracer --input cooked_poster.png \
                  --output result_popart.svg \
                  --mode spline \
                  --colormode color \
                  --hierarchical cutout \
                  --filter_speckle 4 \
                  --color_precision 8 \
                  --path_precision 3

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "popart-v${{ github.run_number }}"
          name: "Deep Shadow Result #${{ github.run_number }}"
          files: result_popart.svg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
