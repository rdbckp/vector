name: Logo Vectorize

on:
  workflow_dispatch:
    inputs:
      image_url:
        description: 'Tempel Link URL Gambar (Kosongkan jika ingin pakai file di repo)'
        required: false
      file_name:
        description: 'Nama File di Repo (Jika URL kosong. Contoh: input.png)'
        default: ''
        required: false
      dpi_resample:
        description: 'Resolusi (DPI) - Makin tinggi makin detail'
        default: '500'
        required: true
      threshold_percent:
        description: 'Threshold (%) - Ketebalan garis (40-60)'
        default: '50'
        required: true
      smoothness:
        description: 'Smoothness (AlphaMax) - 1.0 (tegas) s/d 1.3 (meliuk)'
        default: '1.1'
        required: true
      turdsize:
        description: 'Anti-Rontok (Turdsize) - Hapus bintik (angka 10-100)'
        default: '50'
        required: true

jobs:
  trace-process:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Pro Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick potrace

      - name: Detect and Fetch Image
        run: |
          # Logika milih file: URL > Manual Input > Auto-detect lokal
          URL_INPUT="${{ github.event.inputs.image_url }}"
          USER_FILE="${{ github.event.inputs.file_name }}"
          
          if [ -n "$URL_INPUT" ]; then
            echo "üåê Download gambar dari URL..."
            curl -L "$URL_INPUT" -o "target_image"
            TARGET_FILE="target_image"
          elif [ -n "$USER_FILE" ]; then
            TARGET_FILE="$USER_FILE"
          else
            TARGET_FILE=$(ls input.png input.jpg input.jpeg 2>/dev/null | head -n 1)
          fi
          
          if [ ! -f "$TARGET_FILE" ]; then
            echo "‚ùå WADUH! File kaga nemu, Bro! Cek URL atau nama file di repo."
            exit 1
          fi
          
          echo "üöÄ Gaspol pake file: $TARGET_FILE"

          # --- TAHAP 1: MASAK BITMAP (ImageMagick) ---
          convert -density ${{ github.event.inputs.dpi_resample }} "$TARGET_FILE" \
                  -resample ${{ github.event.inputs.dpi_resample }} \
                  -colorspace gray \
                  -threshold ${{ github.event.inputs.threshold_percent }}% \
                  -blur 0x0.5 \
                  -morphology Smooth Octagon \
                  temp_cooked.bmp

          # --- TAHAP 2: EKSEKUSI TRACE (Potrace) ---
          potrace temp_cooked.bmp \
                  -s \
                  --alphamax ${{ github.event.inputs.smoothness }} \
                  --turdsize ${{ github.event.inputs.turdsize }} \
                  --opttolerance 0.2 \
                  -o logo_vector.svg

      - name: Create Release and Upload
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ github.run_number }}-vector"
          name: "Logo Vector Result #${{ github.run_number }}"
          body: |
            **Vector Specs:**
            - Source: ${{ github.event.inputs.image_url || github.event.inputs.file_name || 'Auto-detected' }}
            - DPI: ${{ github.event.inputs.dpi_resample }}
            - Threshold: ${{ github.event.inputs.threshold_percent }}%
            - Smoothness: ${{ github.event.inputs.smoothness }}
            - Anti-Rontok: ${{ github.event.inputs.turdsize }}
          files: logo_vector.svg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
